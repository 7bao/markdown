<div align='left'><img src="/home/bqq/图片/zc.png"  style=' width:200px'  />

<h1><center>基于IEC 61375-2-3协议的列车拓扑发现协议研究与设计</center></h1>

1. IEC 61375-2-3协议研究

   > 　　国际电工委员会IEC于2010年发布《IEC 61375-2-5》草案作为基于以太网的列车通信网络标准，它在传统工业以太网协议上做了某些方面的修改，以适应列车通信网络的要求，同时又保留了工业以太网通信速率快、带宽高、兼容性强的优点，实现了列车网络控制系统在不同种类的网络和设备之间的开放性和互通性。
   >
   > 　　《IEC 61375-2-5》协议定义了以太网列车骨千网ETB（Ethernet Train Backbone），ETB的主要内容基IEEE 802.3以太网协议以及TCP/IP协议标准的1至4层，分别是物理层、数据链路层、网络层和传输层。专门定义了列车拓扑发现协议TTDP（Train Topology Discovery Protocol）来执行列车网络的初始化行，与此同对对列车网络的数据结构、冗余机制、命名规则、网络服务质量、数据分类等内容也进行了详细的定义与说明。

   1.1 拓扑结构

   > 　　传统列车网络协议中主要采用的拓扑结构有：总线型拓扑结构、星型拓扑结构以及环型拓扑结构在《IEC 61375-2-5》协议中规定列车网络需要采用线性拓扑结构。拓扑结构图如图1-1所示。
   >
   > ![1540975125478](/home/bqq/.config/Typora/typora-user-images/1540975125478.png)
   >
   > <center>图 1-1 列车网络线性拓扑结构图</center>
   >
   > 线性拓扑结构中网的各个节点依次建立连接关系，车头和车尾两个节点由于其位置特殊性，只有单方向的邻居节点，其他中间部分的节点在左右方向都会有相邻节点，列车网络只可以在互为邻居的节点之间直接进行数据通信。
   >
   > 　　由于网络采用线性拓扑结构，拓扑在不同的方向上应该要进行区分，为此《IEC 61375-2-5》协议中定义了两个参考方向。如图2-1中所示，从车尾指向车头定义为方向1，从车头指向车尾定义为方向2。为了确保数据的正确收发和传递，所有的骨干网络节点都应该保持相同的方向性。
   >
   > 　　基于以太网的列车网络从结构上可以分为三层网络体系，如图2-2分层拓扑结构图所示，三层网络体系分别是列车级、车厢级和终端设备级。由图可见，列车级网络通过骨干网络节点将不同的车厢连接起来，也就是《IEC 61375-2-5》协议所定义的ETB。车厢级网络连接同一车厢内的终端设备，由《IEC 61375-3-4》协议所定义的ECN实现。终端设备级网络则是完成各个终端控制设备或者传感器设备的连接。图中最上层Consist是指列车级的组网，中间ETBN代表车厢级的骨干网节点，最下层的Ending Devices代表终端设备级。
   >
   > ![1540976787779](/home/bqq/.config/Typora/typora-user-images/1540976787779.png)
   >
   > <center>图 1-2 列车网络分层拓扑结构图</center>

   1.2  列车拓扑发现协议

   > 　　《IEC 61375-2-5》协议中专门定义了列车拓扑发现协议TTDP（Train Topology Discovery Protocol）来实现列车网络的初始化运行，列车初始化运行完成对列车网络中所有节点进行配置的工作，在列车每次上电之后都需要运行此协议。
   >
   > 　　TTDP协议的目标是建立一个带方向的有序表，因此列车网络初运行必须建立在骨干网为线性拓扑结构的基础之上，并且禁止环形或树形等网络拓扑结构。TTDP完成的主要任务是计算出列车组网中所有子网络的标识号（subnet ID）和所有以太列车骨干网节点（ETBN ID）的标识号，然后通过使用这两种标识号来建立整个列车网络的路由定义、网络地址转换规则、IP映射以及终端设备的命名等。为了方便确定出这两种标志号，《IEC 61375-2-5》协议建立了物理拓扑和逻辑拓扑的定义：
   >
   > 　　物理拓扑：定义了骨干网络节点的顺序和方向，并将其保存为一个列表，保存在一个名为连接（Connectivity Table）的数组中，通过侦测骨干网上所连接的网络节点（包括主节点和冗余节点）而进行更新。
   >
   > 　　逻辑拓扑：定义了列车子网的顺序和方向，并将其保存为一个列表，由名为列车网络目录（Train Network Directory）的数组记录，数组中定义了列车组网中子网络的DD号和以太骨千网节点的ID号，子网和骨干网之间的数据交互就是基于此数组来进行的。列车上电后在所有骨干网络节点上运行TTDP协议，具体的运行过程如下：
   >
   > 　　1）网络始终保持运行TTDP进程，每一个骨干网络节点都通过多播的传输方式发送TOPOLOGY数据帧，同时其他所有的骨干网络节点在接收到新的TOPOLOGY帧之后，根据数据帧的内容更新本地的路由转发表。
   >
   > 　　2）向列车网络的应用申明自己的拓扑发现信息以及获取组网的拓扑信息。
   >
   > 　　3）在获得组网的网络拓扑信息以后，通过逻辑拓扑来建立列车骨干网节点的IP映射，完成DHCP， DNS， NTP等网络服务的更新，同时向新发现的节点通告终端设备情况，最后阻塞骨干网的端结点端口，只发送TTDP HELLO帧实现最终耦合。通过周期性的以多播的方式发送TTDP TOPOLOGY帧，在网络运行时每个骨干网节点都会不断地检测骨干网络上的其他节点，由于线型拓扑网络具有方向性，需要向左右两个方向发送TOPOLOGY帧。当骨干网节点收到该TOPOLOGY帧之后，会根据该数据喊的源MAC地址来查找本地的转发表，根据转发表的内容确定收到的帧是来自左邻居还是右邻居，从而发现整个网络的拓扑结构发现。
   >
   > 　　所有骨干网节点都通过周期性地发送TTDP HELLO帧来探测邻居节点，这种HELLO帧的数据结构很小，主要的目的是发现邻居节点以及检测与邻居节点的连通性，以提供出现异常情况时快速的反应。
   >

   1.3 数据帧和报文格式

   > 　　《IEC 61375-2-5》协议数据链路层的数据帧结构为标准的802.3以太网数据帧，帧结构如图所示
   >
   > |     目标地址      | 原地址 |  类型  | 数据字段 | 校验位 |
   > | :---------------: | :----: | :----: | :------: | :----: |
   > | 01-80-C2-00-00-0E |        | 0x88CC |          |  CRC   |

   > 　　目的MAC地址：数据帧发往的MAC地址，长度为6字节，所有网口都拥有唯一的MAC地址；
   >
   > 　　源MAC地址：数据帧发送的MAC地址，长度为6字节；
   >
   > 　　类型：用于指示以太网的类型，长度为2字节；
   >
   > 　　数据字段：存储长度为46~1500字节长度的数据内容
   >
   > 　　校验位：采用CRC校验方式，长度为4字节虽然数据帧采用802.3的标准结构，但是在《IEC 61375-2-5》协议中没有对LLC帧服务作详细的定义，主要通过数据帧中以太网类型位来区分不同的数据帧应用。协议规定以太网类型是0x88CC的数据报文为TTDP数据帧，以太网类型是0x0806的数据报文为ARP数据帧，以太网类型是0x0800的数据报文为IP数据帧。通过以太网类型的不同对数据报文进行不同的处理。与此同时协议中为了方便对数据的处理，在以太网数据报文中还加入了前置数据帧，内容包括目旳端口、源端口、帧方向等。
   >
   > 　　TTDP初运行数据包中主要包含三种类型的帧格式，分别是TTDP HELLO帧、TTDP TOPOLOGY 帧、TTDP CSTINFO 报文。
   >
   > 　　1）TTDP HELLO 帧
   >
   > 　　HELLO帧的主要作用是发现邻居节点，同时测试与邻居节点的物理通信链路的连通性，线性拓扑网络上相邻的节点之间会周期性地通过交换TTDP HELLO帧来确定自己的邻居节点。HELLO帧的数据定义如下：
   >
   > 　　目的MAC地址：长度为6字节，固定为01-80-C2-00-00-0E；
   >
   > 　　源MAC地址：长度为6字节，数据帧发送方的地址；
   >
   > 　　类型：用于指示以太网的类型，长度为2字节，固定位0x88CC；
   >
   > 　　源端口 ：数据帧发送的网口标号，长度为2字节；
   >
   > 　　帧方向：描述帧发出的方向，0x1表示方向1，0x2表示方向2。
   >
   > 　　2）TTDP TOPOLOGY帧
   >
   > 　　TOPOLOGY帧的主要作用是通告所有的骨干网节点本节点的邻居发现信息，所有骨干网络节点都会周期性地以广播的方式发送TTDP TOPOLOGY帧。网络节点收到该数据帧后，会根据帧的相关内容，判断帧的发送方向是来自左方向还是右方向，同时更新本节点的转发表，从而构建出整个网络的拓扑结构。TOPOLOGY帧的数据 定义如下：
   >
   > 　　目的MAC地址：长度为6字节，画定为01-80-C2-00-00-10；
   >
   > 　　源MAC地址：长度为6字节，数据帧发送方的地址；
   >
   > 　　类型:用于指示以太网的类型，固定位0X88CC；
   >
   > 　　源端口：数据帧发送的网口标号，长度为2字节；
   >
   > 　　方向1的MAC地址：该节点在方向1上的邻居节点的MAC地址；
   >
   > 　　方向2的MAC地址：该节点在方向2上的邻居节点的MAC地址。 
   >
   > 　　3）TTDP CSTINFO报文
   >
   > 　　初运行结束后所有的骨干网节点都会相互发送TTDP CSTINFO数据包，向其他节点传递有关本组的信息，内容包括：组网标志号、车厢的属性、车载终端设备属性等，CSITNFO倾的数据定义如下：
   >
   > 　　多播IP：值固定为239.192.0.3。
   >
   > 　　UDP端口号：值固定为61375。

   1.4 数据分类

   > 　　在《IEC 61375-1》协议中定义了四种数据类，分别是进程数据、消息数据、流数据和`尽力而为`数据，这些数据分类同样支持在《IEC 61375-2-5》协议中定义。对于以太列车骨干网的管理，《IEC 61375-2-5》还额外定义了一种数据类型即监管数据。
   >
   > 　　监管数据用于列车骨干网的初运行和完整监控过程，不能够被应用层所调用，该数据具有最高级别的优先级。
   >
   > 　　进程数据主要应用在列车控制和监控方面。进程数据以每秒10到100数据报的速度循环发送。进程数据传输的最大的等待时间在以太歹阵骨干网上应该要小于20ms。进程数据有较高的传输优先级。
   >
   > 　　消息数据的典型应用是列车控制和监视，乘客信息以及报表。消息数据传输的最大的等待时间在ETB上应该要小于100ms，通过单播地址和选择性的多播地址方式进行传输。消息数据具有中等的传输优先级。
   >
   > 　　流数据的主要应用于传输视频和音频等多媒体数据。视频流数据可以用来监控列车安全状况、乘客娱乐等服务。音频流数据可以作为乘客信息或者工作通信使用。具体要求根据音视频服务来决定。视频数据需要较高的带宽而音频数据需要较低的等待时间和误码率。咅频流数据的传输延迟应该少于125ms。音频流数据的传输不稳定时间应该少于25ms。流数据的带宽需要限制以便进程数据、消息数据和监控数据有足够的带宽。尽力而为数据可以用来下载和上传软件，配置数据或者乘客信息和环境数据。比较典型的是使用FTP协议或者网络管理协议。尽力而为数据的带宽应该要限制，以便为进程数据、消息数据、监控数据和流数据预留足够的带宽。
   >
   > 　　由于数据类型不同对于传输的优先级也不同，从而保证重要数据的优先通信，通过数据分类提高列车网络的可靠性。

   ---

2. 软件架构设计

   > 　　本章内容详细阐述了 《IEC 61375-2-5》协议（本章后简称协议）的具体软件架构的设计内容，实现协议下图2.1中的前三部分，是实现TTDP功能的应用基础。
   >
   > ```mermaid
   > gantt
   >         dateFormat  MM-D
   >         title 架构甘特图
   > 
   >         section 开发
   >         设备初始化模块:	done,p1, 1d
   >         路由功能模块:        p2,after p1, 1d
   >         网络协议模块:        p3,after p2, 1d
   >         TTDP功能模块:      active, p4,after p3, 1d
   > ```
   >
   > <center>图 2.1 协议架构甘特图</center>

   2.1 软件模块组成

   > 　　该列车ETB网络通信模型软件架构主要由4个模块构成，分别是：设备初始化模块、路由器功能模块、网络协议模块和TTDP(列车拓扑发现协议)功能模块，每个模块实现的功能如表２-1所示。
   >
   > <center>表 2-1</center>
   >
   > | 模块名称       | 功能描述               |
   > | -------------- | ---------------------- |
   > | 设备初始化模块 | 底层初始化操作         |
   > | 路由功能模块   | 实现所有的路由功能     |
   > | 网络协议模块   | 实现不要的网络协议功能 |
   > | TTDP功能模块   | TTDP网络发现功能       |

   2.2 设备初始化模块

   >　　设备初始化模块主要4个模块：线程初始化模块，内存初始化模块，内存栈管理初始化模块和数据包管理模块。每个模块的功能简述如表3-2所示。
   >
   >| 名称         | 功能                 |
   >| ------------ | :------------------- |
   >| 线程初始化   | 底层线程的初始化     |
   >| 内存初始化   | TCP/IP内存管理初始化 |
   >| 内存栈初始化 | TCP/IP内存栈管理     |
   >| 数据包管理   | 数据包接口初始化     |
   >
   >　　首先线程初始化模块创建一个线程链表，这个线程链表对所有新开启线程进行管理，内存初始化模块实现TCP/IP协议的内存管理初始化工作，内存栈初始化模块则是实现与之相关的内存栈的初始化。完成以上三个模块的功能之后，网络初始化阶段结束，通过数据包管理模块对网络所有的数据包函数进行初始化操作，列车网络运行期间的网口初始化、ARP和IP协议族的初始化工作都通过此模块完成。

   2.3 路由功能模块

   > 路由一般包括以下基本功能：
   >
   > - Quality of Service and Scheduling
   > - Port-Based VLAN
   > - IEEE 802.1Q VLAN
   > - Double-Tagging
   > - Jumbo Frame Support
   > - Port Trunking/Aggregation
   > - Rate Control
   > - Protected Ports
   > - Port Mirroring
   > - IGMP Snooping
   > - MLD Snooping
   > - IEEE 802.1X Port-Based Security
   > - DoS Attack Prevention
   > - Software Reset
   > - CableChecker
   > - Egress PCP Remarking
   > - Address Management

   2.4 网络协议模块

   > 　　根据以太网通信功能选择需要实现的网络协议，如图2.2所示。
   >
   > <center>表 2-2</center>
   >
   > | 协议           | 功能                     |
   > | -------------- | ------------------------ |
   > | 应用层协议     | 按需实现                 |
   > | 输层协议       | TTDP Cstinfo帧传输协议等 |
   > | 网络层协议     | 基础协议                 |
   > | 数据链路层协议 | 支持TTDP实现的协议等     |
   >
   > 　　层次之间的关系如图2.2所示，TTDP协议需要各种网络协议的支持，特别是数据链路层协议的支持。
   >
   > ```mermaid
   > graph TD
   > 	subgraph 应用层
   > 	TRDP[TRDP]
   >     APP_OTHER[...]
   >     end
   >     subgraph 传输层
   >     TCP[TCP]
   >     UDP[UDP]
   >     TRANS_OTHER[...]
   >     end
   >     subgraph 网络层
   >     IP[IP]
   >     NET_OTHER[...]
   >     end
   >     subgraph 数据链路层
   >         IEEE802.1[IEEE 802.1]
   >         IEEE802.2[IEEE 802.2]
   >         IEEE802.11[IEEE 802.11]
   >         DATA_OTHER[...]
   >     end
   >     TRDP---TCP
   >     TRDP---UDP
   > 
   >     
   >     TCP---IP
   >     UDP---IP
   > 
   >     IP---IEEE802.1
   >     IP---IEEE802.2
   >     IP---IEEE802.11
   > 
   > ```
   >
   > <center>图 2.2 网络协议</center>

   2.5 TTDP功能模块

   > 　　TTPD模块的功能是实现《IEC 61375-2-5》协议所定义的列车拓扑发现协议。列车拓扑发现协议定义了两种类型的数据顿：TTDP HELLO帧和TTDP TOPOLOGY帧。模块可以分解为2个部分：
   >
   > - HELLO数据包
   >   - 发送HELLO帧；
   >   - 接受HELLO帧。
   > - TOPO数据包
   >   - 发送TOPO帧；
   >   - 接受TOPO帧。
   > - TTDP数据调度器
   >   - 调度帧的发送与接收。
   > - 网络拓扑自动编组算法
   >   - 生成编组信息。
   >
   > 　　通过列车网络节点之间传递HELLO帧和TOPOLOGY帧，以实现列车网络的拓扑发现，实现网络的初始化运行。

3. 小结

   > 　　主要介绍了 IEC 61375-2-5协议的列车软件架构设计。软件设计由四个部分组成，包括设备初始化模块、路由器功能模块、网络协议模块和TTDP(列车拓扑发现协议)功能模块。详细阐述了每个模块的模块分解、程序组成和完成的具体功能，用来实现了以太网通信功能和TTDP协议。对IEC 61375-2-5协议定义的列车网络拓扑发现协议进行了设计。



   <div align='right'>
       <p>Posted by: Qiguo Ruan</p></div>

   <div align='right'><p>Email: <a href="mailto:ruanqg@csrzic.com">ruanqg@csrzic.com</a></p></div>

